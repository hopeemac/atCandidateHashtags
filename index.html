<!DOCTYPE html>
<html>
<head>
    
    <title>Hashtag Tracking</title>
    
    <script src="//d3js.org/d3.v4.min.js"></script>
	<link rel="stylesheet" type="text/css" href="hashtagStyle.css">
    <meta charset="UTF-8">
	
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-73887344-1', 'auto');
	  ga('send', 'pageview');

	</script>
    
</head>

<body>
<h1 align="center">2016 Presidential Election Debates - Directed Tweets (@) Hashtag Analysis </h1>

<div class="container">

	<div class='debateButtons'>
		<form onClick="changeDebate()">
			<input type="radio" name="debate" value="20161009" checked="checked"> Oct. 9 Pres Debate<br>
		  <input type="radio" name="debate" value="20161004"> Oct. 4 VP Debate<br>
		  <input type="radio" name="debate" value="20160926"> Sept. 26 Pres Debate<br>
		</form>
	</div>
	
	<div class='candidateButtons'>
		<span id="candidatedisplay"></span>
		<button id="democrat" onclick="changeCandidate(this.id)" style="background-color: blue" class="candidateButton">Hillary Clinton (D)</button>
		<button id="republican" onclick="changeCandidate(this.id)" style="background-color: red" class="candidateButton">Donald Trump (R)</button>
	</div>
	
</div>

<div id="floater">
	<span id="hashtag" style="font-weight: bold"></span><br />
</div>
	
<div id="floatingTop10">
	<span id="top10" style="font-weight: bold"></span><br />
</div>
	
<script>
	
var parseTime = d3.timeParse("%Y-%m-%d %H:%M:%S");
var bisectDate = d3.bisector(function(d) { return d.date; }).left;
	
var candidateParty = 'democrat';
var candidateMaster = 'HillaryClinton';
var allData;
var allCities;
var x, y, z;
var topList;

function getData(){
	
	if(getRadioValue('debate') == 20161004){
		d3.select('#democrat').text('timkaine')
		d3.select('#republican').text('mike_pence')
		if (candidateParty == 'democrat'){
		candidateMaster = 'timkaine';}
		else {candidateMaster = 'mike_pence';}
	}
	else{
		d3.select('#democrat').text('HillaryClinton')
		d3.select('#republican').text('realDonaldTrump')
		if (candidateParty == 'democrat'){
		candidateMaster = 'HillaryClinton';}
		else {candidateMaster = 'realDonaldTrump';}
	}
	
	// Get Data for the Selected Debate
	console.log(getRadioValue('debate'));
	console.log(candidateMaster);
	
	
	fileName = './data/'+candidateMaster+"_hash_minuteTop10_" +getRadioValue('debate')+".csv"
	//fileName = candidateMaster+"_hash_minuteTop10.csv"
	
	
	d3.json('./data/'+candidateMaster+"_topList_"+getRadioValue('debate')+".json", function(data) {
		topList = data;
		// Get the main data set
		d3.csv(fileName, type, function(error, data) {
		  if (error) throw error;
			allData = data;
		  var cities = data.columns.slice(1).map(function(id) {
			return {
			  id: id,
			  values: data.map(function(d) {
				return {date: d.date, temperature: d[id]};
			  })
			};
		  });
		allCities = cities;
		makeChart();
		});
	});
}
getData();
	
function makeChart(){
	data = allData;
	cities = allCities;

	d3.select("#candidatedisplay").text("Selected Candidate: '"+candidateMaster+"' ");

	// Change SVG Size to fit browser window
	var windowWidth = window.innerWidth;
	var windowHeight = window.innerHeight - 180;
	// Change SVG Size to fit browser window
	//d3.select("svg")
	//	.attr("width",window.innerWidth)
	//	.attr("height",window.innerHeight - 150);

	var margin = {top: 20, right: 30, bottom: 30, left: 50};

	var width = windowWidth - margin.left - margin.right,
		height = windowHeight - margin.top - margin.bottom;

	var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	// Create invisible rect for mouse tracking
	svg.append("rect")
	.attr("width", width)
	.attr("height", height)                                    
	.attr("x", 0) 
	.attr("y", 0)
	.attr("id", "mouse-tracker")
	.style("fill", "white")
	.style("stroke","white"); 
	;

	// Add mouseover events for hover line.
	d3.select("#mouse-tracker") // select chart plot background rect #mouse-tracker
		.on("mousemove", mousemove2)	 // on mousemove activate mousemove function defined below
		.on("mouseout", function() {
		console.log('called mouse move')
	});

	x = d3.scaleTime().range([0, width]),
	y = d3.scaleLinear().range([height, 0]),
	z = d3.scaleOrdinal(d3.schemeCategory10);

	var line = d3.line()
		.curve(d3.curveLinear)
		.x(function(d) { return x(d.date); })
		.y(function(d) { return y(d.temperature); });



	x.domain(d3.extent(data, function(d) { return d.date; }));

	y.domain([
	d3.min(cities, function(c) { return d3.min(c.values, function(d) { return d.temperature; }); }),
	d3.max(cities, function(c) { return d3.max(c.values, function(d) { return d.temperature; }); })
	]);

	z.domain(cities.map(function(c) { return c.id; }));

	var g = d3.select("g");

	g.append("g")
	  .attr("class", "axis axis--x")
	  .attr("transform", "translate(0," + height + ")")
	  .call(d3.axisBottom(x));

	g.append("g")
	  .attr("class", "axis axis--y")
	  .call(d3.axisLeft(y))
	.append("text")
	  .attr("transform", "rotate(-90)")
	  .attr("y", 6)
	  .attr("dy", "0.71em")
	  .attr("fill", "#000")
	  .text("Number of Tweets");

	var city = g.selectAll(".city")
	.data(cities)
	.enter().append("g")
	  .attr("class", "city");

	city.append("path")
	  .attr("class", "line")
	  .attr("d", function(d) { return line(d.values); })
	  .style("stroke", function(d) { return z(d.id); })
		.attr("id",function(data) { return data.id; })
		.on("mouseover",showHashtag)
		.on("mouseout",hideHashtag);

	// Hover line 
	var hoverLineGroup = svg.append("g") 
	.attr("class", "hover-line");

	var hoverLine = hoverLineGroup // Create line with basic attributes
		.append("line")
		.attr("id", "hover-line")
		.attr("x1", 10).attr("x2", 10) 
		.attr("y1", 0).attr("y2", height + 10)
		//.style("pointer-events", "none") // Stop line interferring with cursor
		//.style("opacity", 1e-6) // Set opacity to zero
		.attr("fill","black");

	var hoverDate = hoverLineGroup
		.append('text')
		.attr("class", "hover-text")
		.attr("y", height - (height-40)) // hover date text position
		.attr("x", width - 150) // hover date text position
		.style("fill", "#E6E7E8");
}

function type(d, _, columns) {
  d.date = parseTime(d.date);
  for (var i = 1, n = columns.length, c; i < n; ++i) d[c = columns[i]] = +d[c];
  return d;
}

// Setting up Alt Text for the Lines with Hashtag
function showHashtag(){
	console.log('Showing #tag')
	console.log(this.id)
	d3.select("#hashtag").text(this.id);
	d3.select("#floater")
		.style("top", (d3.event.pageY-20) + "px")
		.style("left", (d3.event.pageX)+ "px")
		.style("visibility","visible");
		;
}

function hideHashtag(){
	console.log('hide #tag')
	d3.select("#floater")
		.style("visibility","hidden");
		;
}
	
function changeCandidate(candidate){
		candidateParty = candidate;
		//var fileName = candidateMaster+'_hash_minuteTop10.csv'
		d3.select("svg").remove();
		d3.selectAll(".city").remove(); 
        //d3.selectAll(".labels").remove();
        d3.selectAll(".axis.axis--x").remove();
        d3.selectAll(".axis.axis--y").remove();
		getData();
}
	
function getRadioValue(theRadioGroup){
	var elements = document.getElementsByName(theRadioGroup);
	for (var i = 0, l = elements.length; i < l; i++)
	{
		if (elements[i].checked)
		{
			return elements[i].value;
		}
	}
}
function changeDebate(){
	d3.select("svg").remove();
	d3.selectAll(".city").remove(); 
	//d3.selectAll(".labels").remove();
	d3.selectAll(".axis.axis--x").remove();
	d3.selectAll(".axis.axis--y").remove();
	getData();
	if (getRadioValue('debate') == 20161004){
		console.log('switch candidates')
	} 
}
	
function mousemove2() {
	data = allData;
	//console.log(data)
    
	var mouse_x = d3.mouse(this)[0]; // Finding mouse x position on rect
    var graph_x = x.invert(mouse_x); // 
	console.log(d3.mouse(this)[0]);
	console.log(graph_x);
	var formatKey = d3.timeFormat("%Y-%m-%d %H:%M:%S");
	var ftedKey = formatKey(graph_x);
	//console.log(ftedKey);
	//console.log(topList[ftedKey]);
      //var mouse_y = d3.mouse(this)[1]; // Finding mouse y position on rect
      //var graph_y = yScale.invert(mouse_y);
      //console.log(graph_x);
      
      //var format = d3.time.format('%Y'); // Format hover date text to show three letter month and full year
      
     //d3.select("#hoverDate")
	//	 .text(graph_x); // scale mouse position to x date and format it to show month and year
      
      d3.select("#hover-line") // select hover-line and changing attributes to mouse position
          .attr("x1", mouse_x) 
          .attr("x2", mouse_x)

          //.style("opacity", 1); // Making line visible
	console.log('gothere')
      // Legend tooltips // http://www.d3noob.org/2014/07/my-favourite-tooltip-method-for-line.html
		var x0 = x.invert(d3.mouse(this)[0]); /* d3.mouse(this)[0] returns the x position on the screen of the mouse. x.invert function is reversing the process that we use to map the domain (date) to range (position on screen). So it takes the position on the screen and converts it into an equivalent date! */
		console.log(x0);
      var i = bisectDate(data, x0, 1); // use our bisectDate function that we declared earlier to find the index of our data array that is close to the mouse cursor
      /*It takes our data array and the date corresponding to the position of or mouse cursor and returns the index number of the data array which has a date that is higher than the cursor position.*/
		  console.log('gothere')
      var d0 = data[i - 1],
      d1 = data[i],
      /*d0 is the combination of date and rating that is in the data array at the index to the left of the cursor and d1 is the combination of date and close that is in the data array at the index to the right of the cursor. In other words we now have two variables that know the value and date above and below the date that corresponds to the position of the cursor.*/
      d = x0 - d0.date > d1.date - x0 ? d1 : d0;
      /*The final line in this segment declares a new array d that is represents the date and close combination that is closest to the cursor. It is using the magic JavaScript short hand for an if statement that is essentially saying if the distance between the mouse cursor and the date and close combination on the left is greater than the distance between the mouse cursor and the date and close combination on the right then d is an array of the date and close on the right of the cursor (d1). Otherwise d is an array of the date and close on the left of the cursor (d0).*/

      //d is now the data row for the date closest to the mouse position
	console.log(d.date);
	console.log(topList[formatKey(d.date)]);
	d3.select('#floatingTop10')
		.html(topList[formatKey(d.date)])
		.style("left", (mouse_x+60)+ "px") 
        .style("top", 200+ "px")
		.style("pointer-events", "none");
      //focus.select("text").text(function(columnName){
         //because you didn't explictly set any data on the <text>
         //elements, each one inherits the data from the focus <g>

      //   return (d[columnName]);
      //});
      
  }; 
	
// Change size of the plot when the browser window is re-sized
window.onresize = function(event) {
	changeCandidate(candidateMaster);
};
	
</script>


</body>
		

</html>